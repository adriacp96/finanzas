<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plantilla Finanzas E-Ink</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: serif; background: #fff; color: #000; margin: 0; padding: 15px; line-height: 1.2; }
    h1, h2 { font-family: sans-serif; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 4px; }
    h1 { font-size: 1.3rem; margin-top: 0; }
    h2 { font-size: 0.85rem; margin-top: 25px; background: #000; color: #fff; padding: 3px 6px; }

    .section { margin-bottom: 25px; }
    .box { border: 2px solid #000; padding: 10px; margin-bottom: 15px; }
    
    label { display: block; font-size: 0.65rem; font-weight: bold; margin-bottom: 3px; text-transform: uppercase; }
    select, input, button { 
      width: 100%; padding: 10px; border: 2px solid #000; border-radius: 0; 
      font-size: 0.95rem; background: #fff; margin-bottom: 8px; color: #000;
      -webkit-appearance: none;
    }
    button { background: #000; color: #fff; font-weight: bold; cursor: pointer; text-transform: uppercase; }
    button.alt { background: #fff; color: #000; }
    
    .btn-del { display: none; width: auto; padding: 4px 10px; font-size: 0.8rem; float: right; margin: 0; background: #000; color: #fff; }
    .editing .btn-del { display: block; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

    .checkbox-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; }
    input[type="checkbox"] { width: 20px; height: 20px; margin: 0; }

    .hidden { display: none; }

    .chart-row { margin: 12px 0; border: 1px solid #000; padding: 8px; }
    .bar-bg { border: 1px solid #000; height: 12px; width: 100%; background: #fff; margin: 4px 0; }
    .bar-fill { background: #000; height: 100%; transition: width 0.3s; }
    .bar-fill.min { background: repeating-linear-gradient(45deg, #000, #000 2px, #fff 2px, #fff 4px); }
    .bar-label { display: flex; justify-content: space-between; font-size: 0.75rem; }

    .item-row { border-bottom: 1px solid #000; padding: 10px 0; overflow: hidden; }
    .muted { font-size: 0.6rem; font-style: italic; margin-top: 2px; }
    
    .sticky-actions { position: sticky; bottom: 0; background: #fff; padding: 10px 0; border-top: 2px solid #000; display: flex; gap: 10px; z-index: 100; }
  </style>
</head>
<body id="mainBody">

  <h1>Cartera E-Ink (Estructura)</h1>

  <div class="section">
    <div class="grid-3">
      <div><label>AÃ±o</label><select id="yearSelect"></select></div>
      <div><label>Mes</label><select id="monthSelect" onchange="refreshAll()">
        <option value="01">Ene</option><option value="02">Feb</option><option value="03">Mar</option>
        <option value="04">Abr</option><option value="05">May</option><option value="06">Jun</option>
        <option value="07">Jul</option><option value="08">Ago</option><option value="09">Sep</option>
        <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dic</option>
      </select></div>
      <div><label>&nbsp;</label><button onclick="refreshAll()">IR</button></div>
    </div>
  </div>

  <div class="section">
    <h2>Pagos Reales</h2>
    <div id="chartsContainer"></div>
  </div>

  <div class="section">
    <h2>Tarjetas</h2>
    <div id="cardsList"></div>
    <div class="box">
      <label>+ Nueva Tarjeta</label>
      <input type="text" id="newCardName" placeholder="Nombre de la tarjeta" />
      <div class="grid">
        <select id="newCardCur"><option>AED</option><option>EUR</option><option>IDR</option></select>
        <button class="alt" id="addCardBtn">AÃ±adir</button>
      </div>
    </div>
  </div>

  <div class="section">
    <h2>Gastos Fijos</h2>
    <div id="fixedList"></div>
    <div class="box">
      <label>+ Nuevo Gasto</label>
      <input type="text" id="fixName" placeholder="Concepto" />
      <div class="grid">
        <input type="number" id="fixAmt" step="0.01" placeholder="Importe" />
        <select id="fixCur"><option>AED</option><option>EUR</option><option>IDR</option></select>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="checkFreq" onchange="toggleFreqOptions()" />
        <span>Pago no mensual</span>
      </div>
      <div id="extraOptions" class="hidden">
        <div class="grid">
          <div><label>Cada cuÃ¡nto</label><select id="fixFreq"><option value="6">6 Meses</option><option value="12">1 AÃ±o</option><option value="36">3 AÃ±os</option></select></div>
          <div><label>Mes Cobro</label><select id="fixMonth"><option value="01">Ene</option><option value="02">Feb</option><option value="03">Mar</option><option value="04">Abr</option><option value="05">May</option><option value="06">Jun</option><option value="07">Jul</option><option value="08">Ago</option><option value="09">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dic</option></select></div>
        </div>
      </div>
      <label>DÃ­a del mes</label><input type="number" id="fixDay" placeholder="1-31" />
      <button class="alt" id="addFixBtn">AÃ±adir Gasto</button>
    </div>
  </div>

  <div class="sticky-actions">
    <button class="alt" id="editToggle" style="flex: 1;">âœŽ Ajustes</button>
    <button id="mainSave" style="flex: 2;">ðŸ’¾ Guardar Nube</button>
  </div>

<script>
// La estructura comienza vacÃ­a para que tÃº introduzcas los datos
let cards = JSON.parse(localStorage.getItem('fin_cards')) || [];
let fixedGasto = JSON.parse(localStorage.getItem('fin_fixed')) || [];

function toggleFreqOptions() {
  const isChecked = document.getElementById("checkFreq").checked;
  document.getElementById("extraOptions").classList.toggle("hidden", !isChecked);
}

function saveToLocal() {
  localStorage.setItem('fin_cards', JSON.stringify(cards));
  localStorage.setItem('fin_fixed', JSON.stringify(fixedGasto));
}

function refreshAll() { renderCards(); renderFixed(); renderCharts(); }

function renderCharts() {
  const container = document.getElementById("chartsContainer");
  const selectedMonth = document.getElementById("monthSelect").value;
  container.innerHTML = "";
  ["AED", "EUR", "IDR"].forEach(cur => {
    const fijosDelMes = fixedGasto.filter(f => f.currency === cur && (f.dueMonth === "all" || f.dueMonth === selectedMonth)).reduce((acc, f) => acc + f.amount, 0);
    let totalDeudaT = 0, totalMinT = 0;
    cards.filter(c => c.currency === cur).forEach(c => {
      const d = document.querySelector(`input[data-card="${c.name}"]`), m = document.querySelector(`input[data-min="${c.name}"]`);
      totalDeudaT += d ? parseFloat(d.value)||0 : 0; totalMinT += m ? parseFloat(m.value)||0 : 0;
    });
    const sumaTotal = fijosDelMes + totalDeudaT, sumaPago = fijosDelMes + totalMinT;
    if (sumaTotal === 0) return;
    const max = cur === "IDR" ? 5000 : (cur === "AED" ? 25000 : 8000);
    container.innerHTML += `<div class="chart-row"><div class="bar-label"><strong>${cur}</strong><span>Deuda: ${sumaTotal.toFixed(2)}</span></div><div class="bar-bg"><div class="bar-fill" style="width:${Math.min((sumaTotal/max)*100,100)}%"></div></div><div class="bar-label"><span>Pago este mes: ${sumaPago.toFixed(2)}</span></div><div class="bar-bg"><div class="bar-fill min" style="width:${Math.min((sumaPago/max)*100,100)}%"></div></div></div>`;
  });
}

function renderCards() {
  const list = document.getElementById("cardsList");
  list.innerHTML = "";
  cards.forEach((c, i) => {
    list.innerHTML += `<div class="item-row"><button class="btn-del" onclick="deleteItem('card', ${i})">X</button><label>${c.name} (${c.currency})</label><div class="grid"><div><label>Deuda Total</label><input type="number" step="0.01" data-card="${c.name}" oninput="renderCharts()"></div><div><label>MÃ­nimo Mes</label><input type="number" step="0.01" data-min="${c.name}" oninput="renderCharts()"></div></div></div>`;
  });
}

function renderFixed() {
  const list = document.getElementById("fixedList");
  const selectedMonth = document.getElementById("monthSelect").value;
  list.innerHTML = "";
  fixedGasto.forEach((f, i) => {
    const isDue = f.dueMonth === "all" || f.dueMonth === selectedMonth;
    list.innerHTML += `<div class="item-row" style="${!isDue ? 'opacity: 0.2' : ''}"><button class="btn-del" onclick="deleteItem('fix', ${i})">X</button><div class="grid"><input type="text" value="${f.name}" onchange="updateFix(${i}, 'name', this.value)" /><select onchange="updateFix(${i}, 'currency', this.value)"><option ${f.currency=='AED'?'selected':''}>AED</option><option ${f.currency=='EUR'?'selected':''}>EUR</option><option ${f.currency=='IDR'?'selected':''}>IDR</option></select></div><div class="grid-3"><div><label>Importe</label><input type="number" step="0.01" value="${f.amount}" onchange="updateFix(${i}, 'amount', this.value)" /></div><div><label>DÃ­a</label><input type="number" value="${f.day}" onchange="updateFix(${i}, 'day', this.value)" /></div><div><label>Cobro</label><select onchange="updateFix(${i}, 'dueMonth', this.value)"><option value="all" ${f.dueMonth=='all'?'selected':''}>Mes</option><option value="01" ${f.dueMonth=='01'?'selected':''}>Ene</option><option value="12" ${f.dueMonth=='12'?'selected':''}>Dic</option></select></div></div></div>`;
  });
  renderCharts();
}

document.getElementById("editToggle").addEventListener("click", function() {
  const isEditing = document.getElementById("mainBody").classList.toggle("editing");
  this.textContent = isEditing ? "âœ“ Guardar" : "âœŽ Ajustes";
});

window.updateFix = (i, fld, val) => { fixedGasto[i][fld] = (fld === 'amount' || fld === 'day') ? parseFloat(val) : val; saveToLocal(); renderFixed(); };

window.deleteItem = (type, i) => { if(!confirm("Â¿Eliminar?")) return; if(type === 'card') cards.splice(i, 1); else fixedGasto.splice(i, 1); saveToLocal(); refreshAll(); };

document.getElementById("addCardBtn").addEventListener("click", () => {
  const n = document.getElementById("newCardName"); if(!n.value) return;
  cards.push({ name: n.value, currency: document.getElementById("newCardCur").value });
  n.value = ""; saveToLocal(); renderCards();
});

document.getElementById("addFixBtn").addEventListener("click", () => {
  const name = document.getElementById("fixName").value, amt = parseFloat(document.getElementById("fixAmt").value), isFreq = document.getElementById("checkFreq").checked;
  if(!name || !amt) return;
  fixedGasto.push({ name, amount: amt, currency: document.getElementById("fixCur").value, day: parseInt(document.getElementById("fixDay").value) || 1, freq: isFreq ? parseInt(document.getElementById("fixFreq").value) : 1, dueMonth: isFreq ? document.getElementById("fixMonth").value : "all" });
  document.getElementById("fixName").value = ""; document.getElementById("fixAmt").value = ""; saveToLocal(); renderFixed();
});

const now = new Date();
for(let y=2026;y<=2031;y++) document.getElementById("yearSelect").add(new Option(y,y,y===now.getFullYear()));
document.getElementById("monthSelect").value = String(now.getMonth()+1).padStart(2,'0');
refreshAll();
</script>
</body>
</html>
